import React from "react";
import { translate } from "react-i18next";
import { Section } from "@datawheel/canon-core";
import { simpleDatumNeed } from "helpers/MondrianClient";

import FeaturedDatum from "components/FeaturedDatum";
import SNEDTooltip from "components/SNEDTooltip";
import { numeral } from "helpers/formatters";
import { SNED } from "texts/GeoProfile";
import Axios from "axios";

class VulnerabilitySlide extends Section {
  constructor(props) {
    super(props);
    this.state = {
      total: undefined,
      first: undefined
    };
  }
  componentDidMount() {
    const { geo } = this.context.data;
    const geoType =
      geo.type.substring(0, 1).toUpperCase() + geo.type.substring(1);

    const path = `/api/data?${geoType}=${
      geo.key
    }&measures=Count&drilldowns=Priority,Year`;
    Axios.get(path).then(resp => {
      const data = resp.data.data.filter(d => d["ID Year"] === 2018);
      const first = data.find(d => d["ID Priority"] === 1) || {};
      const total = data.reduce((all, d) => {
        if ([1, 2, 3].includes(d["ID Priority"])) return all + d["Count"];
        return all;
      }, 0);
      this.setState({ total, first: first["Count"] });
    });
  }

  render() {
    const { children, t, i18n } = this.props;
    let { geo, sned_indicators_datum, datum_sned_score } = this.context.data;

    const locale = i18n.language;
    const text = SNED(sned_indicators_datum, locale);

    const { first, total } = this.state;

    return (
      <div className="topic-slide-block">
        <div className="topic-slide-intro">
          <h3 className="topic-slide-title u-visually-hidden">
            {t("Performance Evaluation")}
          </h3>
          <div className="topic-slide-text">
            <p>
              {t(
                "junaeb_vulnerability",
                { total, rate: numeral(first / total).format("0.0%"), first: numeral(first).format("0,0"), name: geo.caption }
              )}
            </p>
          </div>
          <div className="topic-slide-data">
            <FeaturedDatum
              className="l-1-3"
              icon="health-firstaid"
              datum={"123"}
              title={t("Title")}
              subtitle={"asdf"}
            />
            <FeaturedDatum
              className="l-1-3"
              icon="health-firstaid"
              datum={"45.5"}
              title={t("Title")}
              subtitle={"asdf"}
            />
          </div>
        </div>
        <div className="topic-slide-charts">{children}</div>
      </div>
    );
  }
}

export default translate()(VulnerabilitySlide);
